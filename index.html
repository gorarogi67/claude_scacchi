<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chess Host</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
      background: #f0f0f0;
    }
    #board-container {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      gap: 2px;
      margin-bottom: 20px;
    }
    .square {
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .square.light { background: #eee; }
    .square.dark  { background: #666; color: white; }
    .hidden { display: none; }
    .modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="board-container"></div>
  <div id="controls">
    <button id="new-game-btn">Nuova Partita</button>
    <input type="text" id="game-id-input" placeholder="ID Partita"/>
    <button id="join-game-btn">Rispondi alla Partita</button>
  </div>

  <!-- Promotion Modal -->
  <div id="promo-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Promozione Pedone</h2>
      <div id="promo-options"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

  <script>
    // Configurazione Firebase (metti i tuoi dati)
    const firebaseConfig = {
      apiKey: 'YOUR_API_KEY',
      authDomain: 'YOUR_AUTH_DOMAIN',
      databaseURL: 'YOUR_DB_URL',
      projectId: 'YOUR_PROJECT_ID',
      storageBucket: 'YOUR_STORAGE_BUCKET',
      messagingSenderId: 'YOUR_SENDER_ID',
      appId: 'YOUR_APP_ID'
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameState = null;
    let playerId = null;
    let gameId   = null;
    const boardContainer = document.getElementById('board-container');

    // Inizializza la scacchiera
    function initBoard() {
      boardContainer.innerHTML = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 8; c++) {
          const sq = document.createElement('div');
          sq.classList.add('square', (r + c) % 2 ? 'dark' : 'light');
          sq.dataset.row = r; sq.dataset.col = c;
          sq.setAttribute('role','button');
          sq.setAttribute('aria-label',
            `Casella ${String.fromCharCode(65 + c)}${8 - r}`);
          sq.addEventListener('click', () => handleSquareClick(r, c));
          boardContainer.appendChild(sq);
        }
      }
    }

    // Nuova partita (solo admin)
    async function startNewGame() {
      const pw = prompt('Inserisci password admin:');
      if (pw !== 'chess123') return alert('Password errata');
      playerId = 'player1';
      gameState = { moves: [], turn: 'white' };
      const ref = db.ref('games').push();
      gameId = ref.key;
      await ref.set({
        state: gameState,
        players: { player1: true }
      });
      renderBoard();
      alert(`Partita creata! ID: ${gameId}`);
    }

    // Unisciti a una partita esistente
    async function joinGame() {
      const inputId = document.getElementById('game-id-input').value.trim();
      if (!inputId) return alert('Inserisci un ID valido');
      gameId = inputId;
      playerId = 'player2';
      const gameRef = db.ref('games/' + gameId);
      const snap = await gameRef.get();
      if (!snap.exists()) return alert('Partita non trovata');

      // Segui gli aggiornamenti in realtime
      gameRef.on('value', snap => {
        const data = snap.val();
        gameState = data.state;
        renderBoard();
      });

      // Aggiorna lista giocatori
      await gameRef.child('players/player2').set(true);
      renderBoard();
    }

    // Gestione click su casella
    function handleSquareClick(r, c) {
      makeMove(r, c);
    }

    // Esegui e salva mossa
    async function makeMove(r, c) {
      gameState.moves.push({ r, c, by: playerId });
      await db.ref(`games/${gameId}/state`).set(gameState);
    }

    // Disegna la scacchiera e i pezzi (placeholder)
    function renderBoard() {
      initBoard();
      // Qui disegneresti i pezzi in base a gameState.movesâ€¦
    }

    // Event listeners
    document.getElementById('new-game-btn')
      .addEventListener('click', startNewGame);
    document.getElementById('join-game-btn')
      .addEventListener('click', joinGame);

    // Avvia
    initBoard();
  </script>
</body>
</html>
