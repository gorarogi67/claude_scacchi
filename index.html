<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chess Host</title>
  <style>
    body{
      font-family:Arial, sans-serif;
      display:flex;flex-direction:column;align-items:center;
      margin:0;padding:20px;background:#f0f0f0;
    }
    #board-container{
      display:grid;
      grid-template-columns:repeat(8,60px);
      grid-template-rows:repeat(8,60px);
      gap:2px;margin-bottom:20px;
    }
    .square{width:60px;height:60px;display:flex;justify-content:center;align-items:center;cursor:pointer;}
    .square.light{background:#eee;}
    .square.dark{background:#666;color:#fff;}
    /* Modal */
    .modal{
      position:fixed;top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.5);
      justify-content:center;align-items:center;
      /* IMPORTANTE: di default invisibile */
      display:none;
    }
    .modal.show{display:flex;} /* aggiunta con JS quando serve */
    .modal-content{background:#fff;padding:20px;border-radius:8px;}
  </style>
</head>
<body>
  <div id="board-container"></div>
  <div id="controls">
    <button id="new-game-btn">Nuova Partita</button>
    <input type="text" id="game-id-input" placeholder="ID Partita"/>
    <button id="join-game-btn">Rispondi alla Partita</button>
  </div>

  <!-- Promotion Modal: parte giÃ  invisibile -->
  <div id="promo-modal" class="modal">
    <div class="modal-content">
      <h2>Promozione Pedone</h2>
      <div id="promo-options"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>

  <script>
    // Firebase config (sostituisci con la tua)
    const firebaseConfig = {
      apiKey:'YOUR_API_KEY',
      authDomain:'YOUR_AUTH_DOMAIN',
      databaseURL:'YOUR_DB_URL',
      projectId:'YOUR_PROJECT_ID',
      storageBucket:'YOUR_STORAGE_BUCKET',
      messagingSenderId:'YOUR_SENDER_ID',
      appId:'YOUR_APP_ID'
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let gameState=null, playerId=null, gameId=null;
    const boardContainer=document.getElementById('board-container');
    const promoModal=document.getElementById('promo-modal');

    /* ---------- BOARD ---------- */
    function initBoard(){
      boardContainer.innerHTML='';
      for(let r=0;r<8;r++){
        for(let c=0;c<8;c++){
          const sq=document.createElement('div');
          sq.className='square '+((r+c)%2?'dark':'light');
          sq.dataset.row=r; sq.dataset.col=c;
          sq.addEventListener('click',()=>handleSquareClick(r,c));
          boardContainer.appendChild(sq);
        }
      }
    }

    /* ---------- GAME FLOW ---------- */
    async function startNewGame(){
      const pw=prompt('Inserisci password admin:');
      if(pw!=='chess123') return alert('Password errata');
      playerId='player1';
      gameState={moves:[],turn:'white'};
      const ref=db.ref('games').push();
      gameId=ref.key;
      await ref.set({state:gameState,players:{player1:true}});
      renderBoard();
      alert('Partita creata! ID: '+gameId);
    }

    async function joinGame(){
      const inputId=document.getElementById('game-id-input').value.trim();
      if(!inputId) return alert('Inserisci un ID valido');
      gameId=inputId; playerId='player2';
      const gameRef=db.ref('games/'+gameId);
      const snap=await gameRef.get();
      if(!snap.exists()) return alert('Partita non trovata');

      gameState=snap.val().state||{moves:[],turn:'white'};
      await gameRef.child('players/player2').set(true);

      gameRef.on('value', s=>{
        gameState=s.val().state;
        renderBoard();
      });

      renderBoard();
    }

    function handleSquareClick(r,c){
      // Esempio di trigger promozione
      // if(needsPromotion(r,c)){ openPromotionModal(); return; }
      makeMove(r,c);
    }

    async function makeMove(r,c){
      gameState.moves.push({r,c,by:playerId});
      await db.ref('games/'+gameId+'/state').set(gameState);
    }

    /* ---------- MODAL ---------- */
    function openPromotionModal(){
      promoModal.classList.add('show');
    }
    function closePromotionModal(){
      promoModal.classList.remove('show');
    }

    /* ---------- RENDER ---------- */
    function renderBoard(){
      initBoard();
      // TODO: disegnare i pezzi in base a gameState
      // Assicuriamoci che il modal sia chiuso a ogni render
      closePromotionModal();
    }

    /* ---------- UI events ---------- */
    document.getElementById('new-game-btn').onclick=startNewGame;
    document.getElementById('join-game-btn').onclick=joinGame;

    /* ---------- start ---------- */
    initBoard();
  </script>
</body>
</html>
